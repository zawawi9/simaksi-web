-- =================================================================
-- SCRIPT DATABASE E-SIMAKSI UNTUK SUPABASE (FINAL DENGAN LOGIKA)
-- Versi: 3.0
-- Perubahan:
--   - Menghapus kolom/tabel yang berlebihan (is_verified, verifikasi_email).
--   - Menyempurnakan trigger kuota untuk menangani DELETE.
--   - Memperbaiki tipe data dan keamanan pada function RPC.
-- =================================================================

-- LANGKAH 1: BUAT TIPE KUSTOM (ENUM)
CREATE TYPE "peran_pengguna" AS ENUM ('pendaki', 'admin');
CREATE TYPE "status_reservasi" AS ENUM ('menunggu_pembayaran', 'terkonfirmasi', 'dibatalkan', 'selesai');
CREATE TYPE "status_sampah_enum" AS ENUM ('belum_dicek', 'sesuai', 'tidak_sesuai');
CREATE TYPE "jenis_sampah_enum" AS ENUM ('organik', 'non-organik');


-- LANGKAH 2: BUAT TABEL-TABEL

-- Tabel Kategori Pengeluaran
CREATE TABLE "kategori_pengeluaran" (
"id_kategori" BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
"nama_kategori" VARCHAR(100) NOT NULL UNIQUE,
"deskripsi" TEXT
);

-- Tabel Kuota Harian
CREATE TABLE "kuota_harian" (
"id_kuota" BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
"tanggal_kuota" DATE NOT NULL UNIQUE,
"kuota_maksimal" INT NOT NULL,
"kuota_terpesan" INT NOT NULL DEFAULT 0
);

-- Tabel Poster Promosi
CREATE TABLE "promosi_poster" (
"id_poster" BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
"judul_poster" VARCHAR(255) NOT NULL,
"deskripsi_poster" TEXT,
"url_gambar" VARCHAR(255) NOT NULL,
"url_tautan" VARCHAR(255),
"is_aktif" BOOLEAN NOT NULL DEFAULT TRUE,
"urutan" INT NOT NULL DEFAULT 0,
"dibuat_pada" TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Tabel Pengguna/Profil (DISEMPURNAKAN)
-- Nama tabel saya ubah jadi 'profiles' sesuai konvensi, tapi 'pengguna' juga tidak masalah.
CREATE TABLE "profiles" (
"id" uuid PRIMARY KEY NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
"nama_lengkap" VARCHAR(100) NOT NULL,
"email" VARCHAR(100) UNIQUE NOT NULL, -- Baik untuk disimpan agar mudah join
"nomor_telepon" VARCHAR(20),
"alamat" TEXT,
"peran" peran_pengguna NOT NULL DEFAULT 'pendaki'
-- Kolom 'is_verified' dan 'dibuat_pada' dihapus karena sudah ada di auth.users
);
COMMENT ON TABLE "profiles" IS 'Menyimpan data profil pengguna yang terhubung ke Supabase Auth';

-- Tabel Reservasi
CREATE TABLE "reservasi" (
"id_reservasi" BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
"id_pengguna" uuid NOT NULL REFERENCES "profiles"("id") ON DELETE CASCADE,
"kode_reservasi" VARCHAR(20) NOT NULL UNIQUE,
"tanggal_pendakian" DATE NOT NULL,
"jumlah_pendaki" SMALLINT NOT NULL,
"jumlah_tiket_parkir" SMALLINT NOT NULL DEFAULT 0,
"total_harga" INT NOT NULL,
"status" status_reservasi NOT NULL DEFAULT 'menunggu_pembayaran',
"jumlah_potensi_sampah" SMALLINT,
"status_sampah" status_sampah_enum NOT NULL DEFAULT 'belum_dicek',
"dipesan_pada" TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Tabel Barang Bawaan Sampah
CREATE TABLE "barang_bawaan_sampah" (
"id_barang" BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
"id_reservasi" BIGINT NOT NULL REFERENCES "reservasi"("id_reservasi") ON DELETE CASCADE,
"nama_barang" VARCHAR(255) NOT NULL,
"jenis_sampah" jenis_sampah_enum NOT NULL,
"jumlah" SMALLINT
);

-- Tabel Komentar
CREATE TABLE "komentar" (
"id_komentar" BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
"id_pengguna" uuid NOT NULL REFERENCES "profiles"("id"),
"komentar" TEXT NOT NULL,
"dibuat_pada" TIMESTAMPTZ DEFAULT now(),
"rating" SMALLINT
);

-- Tabel Pemasukan
CREATE TABLE "pemasukan" (
"id_pemasukan" BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
"id_reservasi" BIGINT REFERENCES "reservasi"("id_reservasi") ON DELETE SET NULL,
"id_admin" uuid NOT NULL REFERENCES "profiles"("id"),
"jumlah" INT NOT NULL,
"keterangan" TEXT NOT NULL,
"tanggal_pemasukan" DATE NOT NULL,
"dibuat_pada" TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Tabel Pendaki Rombongan
CREATE TABLE "pendaki_rombongan" (
"id_pendaki" BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
"id_reservasi" BIGINT NOT NULL REFERENCES "reservasi"("id_reservasi") ON DELETE CASCADE,
"nama_lengkap" VARCHAR(100) NOT NULL,
"nik" VARCHAR(20) NOT NULL,
"alamat" TEXT NOT NULL,
"nomor_telepon" VARCHAR(20) NOT NULL,
"kontak_darurat" VARCHAR(100) NOT NULL,
"url_surat_sehat" VARCHAR(255)
);

-- Tabel Pengeluaran
CREATE TABLE "pengeluaran" (
"id_pengeluaran" BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
"id_admin" uuid NOT NULL REFERENCES "profiles"("id"),
"id_kategori" BIGINT REFERENCES "kategori_pengeluaran"("id_kategori") ON DELETE SET NULL,
"jumlah" INT NOT NULL,
"keterangan" TEXT NOT NULL,
"tanggal_pengeluaran" DATE NOT NULL,
"dibuat_pada" TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Tabel Pengumuman
CREATE TABLE "pengumuman" (
"id_pengumuman" BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
"id_admin" uuid NOT NULL REFERENCES "profiles"("id"),
"judul" VARCHAR(255) NOT NULL,
"konten" TEXT NOT NULL,
"start_date" TIMESTAMPTZ NOT NULL,
"end_date" TIMESTAMPTZ NOT NULL,
"telah_terbit" BOOLEAN NOT NULL DEFAULT false,
"dibuat_pada" TIMESTAMPTZ NOT NULL DEFAULT now(),
"diperbarui_pada" TIMESTAMPTZ NOT NULL DEFAULT now()
);

--Tabel atur Harga masuk & Parkir
CREATE TABLE "pengaturan_biaya" (
  "id" BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "nama_item" VARCHAR(100) NOT NULL UNIQUE, //NAma item untuk Parkir atau Tiket masuk
  "harga" INT NOT NULL,
  "deskripsi" TEXT,
  "diperbarui_pada" TIMESTAMPTZ NOT NULL DEFAULT now()
);

COMMENT ON TABLE "pengaturan_biaya" IS 'Menyimpan konfigurasi berbagai item biaya seperti tiket masuk, parkir, dll.';

-- TABEL "verifikasi_email" DIHAPUS SEPENUHNYA.


-- LANGKAH 3: BUAT TRIGGER DAN FUNCTIONS

-- Trigger untuk Kuota (DISEMPURNAKAN)
CREATE OR REPLACE FUNCTION public.update_kuota_terpesan_trigger()
RETURNS TRIGGER AS $$
BEGIN
  -- KASUS 1: Reservasi BARU DIBUAT (INSERT)
  IF (TG_OP = 'INSERT') THEN
    IF NEW.status != 'dibatalkan' THEN
      UPDATE public.kuota_harian
      SET kuota_terpesan = kuota_terpesan + NEW.jumlah_pendaki
      WHERE tanggal_kuota = NEW.tanggal_pendakian;
    END IF;
  
  -- KASUS 2: Reservasi DIPERBARUI (UPDATE)
  ELSIF (TG_OP = 'UPDATE') THEN
    -- Status berubah dari aktif MENJADI 'dibatalkan' -> Kurangi kuota
    IF OLD.status != 'dibatalkan' AND NEW.status = 'dibatalkan' THEN
      UPDATE public.kuota_harian
      SET kuota_terpesan = kuota_terpesan - OLD.jumlah_pendaki
      WHERE tanggal_kuota = OLD.tanggal_pendakian;
    
    -- Status berubah DARI 'dibatalkan' menjadi aktif -> Tambah kuota
    ELSIF OLD.status = 'dibatalkan' AND NEW.status != 'dibatalkan' THEN
      UPDATE public.kuota_harian
      SET kuota_terpesan = kuota_terpesan + NEW.jumlah_pendaki
      WHERE tanggal_kuota = NEW.tanggal_pendakian;
    END IF;
    
  -- KASUS 3: Reservasi DIHAPUS (DELETE) - BARU!
  ELSIF (TG_OP = 'DELETE') THEN
    -- Jika reservasi yang dihapus tidak dalam status 'dibatalkan' -> Kurangi kuota
    IF OLD.status != 'dibatalkan' THEN
        UPDATE public.kuota_harian
        SET kuota_terpesan = kuota_terpesan - OLD.jumlah_pendaki
        WHERE tanggal_kuota = OLD.tanggal_pendakian;
    END IF;
  END IF;
  
  -- Untuk operasi INSERT/UPDATE, kembalikan NEW. Untuk DELETE, kembalikan OLD.
  IF (TG_OP = 'DELETE') THEN
    RETURN OLD;
  ELSE
    RETURN NEW;
  END IF;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Trigger yang memanggil fungsi di atas (DISEMPURNAKAN)
CREATE TRIGGER reservasi_kuota_trigger
AFTER INSERT OR UPDATE OR DELETE ON public.reservasi
FOR EACH ROW EXECUTE FUNCTION public.update_kuota_terpesan_trigger();


-- Fungsi Cek Ketersediaan Kuota (Sudah Bagus)
CREATE OR REPLACE FUNCTION public.cek_ketersediaan_kuota(
    p_tanggal_pendakian DATE,
    p_jumlah_diminta INT
)
RETURNS BOOLEAN AS $$
DECLARE
    v_kuota_tersisa INT;
BEGIN
    SELECT (kuota_maksimal - kuota_terpesan) INTO v_kuota_tersisa
    FROM public.kuota_harian
    WHERE tanggal_kuota = p_tanggal_pendakian;

    IF v_kuota_tersisa IS NOT NULL AND v_kuota_tersisa >= p_jumlah_diminta THEN
        RETURN TRUE;
    ELSE
        RETURN FALSE;
    END IF;
END;
$$ LANGUAGE plpgsql;


-- Fungsi Konfirmasi Pembayaran (DIPERBAIKI total, LEBIH AMAN)
CREATE OR REPLACE FUNCTION public.konfirmasi_pembayaran_dan_catat_pemasukan(
    input_id_reservasi BIGINT
)
RETURNS TEXT AS $$
DECLARE
    v_reservasi RECORD;
    v_admin_id UUID := auth.uid(); -- AMBIL ID ADMIN YANG SEDANG LOGIN SECARA OTOMATIS
    v_is_admin BOOLEAN;
BEGIN
    -- Cek apakah pengguna yang memanggil fungsi ini adalah admin
    SELECT EXISTS (
        SELECT 1 FROM public.profiles WHERE id = v_admin_id AND peran = 'admin'
    ) INTO v_is_admin;

    IF NOT v_is_admin THEN
        RETURN 'Error: Aksi ini hanya dapat dilakukan oleh admin.';
    END IF;

    -- Ambil data reservasi
    SELECT * INTO v_reservasi
    FROM public.reservasi
    WHERE id_reservasi = input_id_reservasi AND status = 'menunggu_pembayaran';

    IF NOT FOUND THEN
        RETURN 'Error: Reservasi tidak ditemukan atau statusnya salah.';
    END IF;

    -- Langkah 1: Ubah status reservasi
    UPDATE public.reservasi
    SET status = 'terkonfirmasi'
    WHERE id_reservasi = input_id_reservasi;

    -- Langkah 2: Tambahkan data ke tabel pemasukan
    INSERT INTO public.pemasukan (id_reservasi, id_admin, jumlah, keterangan, tanggal_pemasukan)
    VALUES (
        input_id_reservasi,
        v_admin_id, -- Gunakan ID admin yang sudah diverifikasi
        v_reservasi.total_harga,
        CONCAT('Pemasukan dari tiket reservasi kode: ', v_reservasi.kode_reservasi),
        CURRENT_DATE
    );

    RETURN 'Success: Reservasi berhasil dikonfirmasi dan pemasukan dicatat.';
EXCEPTION
    WHEN OTHERS THEN
        RETURN 'Error: Terjadi kesalahan pada database.';
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;


//TAMBAHAN

CREATE TABLE "promosi" (
  "id_promosi" BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "nama_promosi" VARCHAR(255) NOT NULL,
  "deskripsi_promosi" TEXT,
  
  -- Bagian "Tipe" Promosi
  "tipe_promosi" VARCHAR(20) NOT NULL CHECK (tipe_promosi IN ('PERSENTASE', 'POTONGAN_TETAP', 'HARGA_KHUSUS')),
  "nilai_promosi" DECIMAL(10, 2) NOT NULL,

  -- Bagian "Kondisi" (Jawaban untuk "jika 5 pendaki")
  "kondisi_min_pendaki" INT DEFAULT 1, -- Minimal jumlah pendaki untuk promo berlaku
  "kondisi_max_pendaki" INT,            -- Opsional: Maksimal jumlah pendaki

  -- Bagian "Waktu" (Jawaban untuk "waktu tayang dan akhir")
  "tanggal_mulai" TIMESTAMPTZ NOT NULL,
  "tanggal_akhir" TIMESTAMPTZ NOT NULL,

  -- Status
  "is_aktif" BOOLEAN NOT NULL DEFAULT TRUE,
  "dibuat_pada" TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Modifikasi tabel Anda yang sudah ada
ALTER TABLE "promosi_poster"
ADD COLUMN "id_promosi_terkait" BIGINT;

-- Tambahkan Foreign Key
ALTER TABLE "promosi_poster"
ADD CONSTRAINT fk_promosi_poster_ke_promosi
FOREIGN KEY ("id_promosi_terkait")
REFERENCES "promosi"("id_promosi")
ON DELETE SET NULL; -- Jika promosinya dihapus, posternya tidak ikut terhapus